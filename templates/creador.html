<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Creador Multi-P√°gina</title>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #cfd8dc; margin: 0; height: 100vh; display: flex; flex-direction: column; }
        
        /* HEADER */
        .header { background: #37474f; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 10;}
        .btn-action { background: #00bcd4; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .btn-action:hover { background: #00acc1; }
        .btn-add { background: #4caf50; margin-right: 15px; }

        .workspace { display: flex; flex: 1; overflow: hidden; height: calc(100vh - 60px);}
        
        /* SIDEBAR */
        .sidebar { width: 200px; background: white; border-right: 1px solid #ccc; padding: 15px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; z-index: 5; }
        .upload-btn { border: 2px dashed #607d8b; color: #607d8b; padding: 10px; text-align: center; cursor: pointer; border-radius: 5px; font-weight: bold; font-size: 14px; }
        .pool-img { width: 100%; height: 80px; object-fit: cover; border-radius: 5px; cursor: pointer; border: 3px solid transparent; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .pool-img:hover { border-color: #00bcd4; transform: scale(1.02); }

        /* AREA DE TRABAJO (SCROLL) */
        .canvas-area { flex: 1; background: #eceff1; overflow-y: auto; padding: 40px; display: flex; flex-direction: column; align-items: center; gap: 40px; }
        
        /* CONTENEDOR DE P√ÅGINA INDIVIDUAL */
        .page-wrapper { position: relative; }
        
        .page-header {
            position: absolute; top: -25px; left: 0; width: 100%; 
            display: flex; justify-content: space-between; color: #546e7a; font-weight: bold; font-size: 14px;
        }
        .btn-del-page { background: #ff5252; color: white; border: none; border-radius: 3px; cursor: pointer; padding: 2px 8px; font-size: 12px; }

        /* LA HOJA DE PAPEL (Clase, ya no ID √∫nico) */
        .thePaper {
            width: 816px; height: 1056px; /* Carta a 96 DPI */
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative; 
            overflow: hidden; 
            transform: scale(0.85); transform-origin: top center;
            margin-bottom: -130px; /* Compensa el espacio blanco del scale */
            border: 1px solid transparent; /* Para que se vea selecci√≥n */
        }
        
        /* Efecto cuando una p√°gina est√° "activa" (√∫ltima usada) */
        .thePaper.active-page { border-color: #00bcd4; box-shadow: 0 0 20px rgba(0, 188, 212, 0.4); }

        /* ELEMENTOS ARRASTRABLES */
        .draggable-item {
            position: absolute; 
            width: 200px; height: auto;
            cursor: move;
            border: 2px solid transparent;
            touch-action: none; user-select: none;
            box-sizing: border-box;
        }
        .draggable-item:hover, .draggable-item.resizing { border: 2px dashed #00bcd4; }
        .draggable-item img { width: 100%; height: 100%; pointer-events: none; display: block;}
        
        .delete-handle {
            position: absolute; top: -12px; right: -12px; width: 24px; height: 24px;
            background: #ff5252; color: white; border-radius: 50%; text-align: center; line-height: 24px;
            cursor: pointer; display: none; z-index: 10; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .draggable-item:hover .delete-handle { display: block; }

    </style>
</head>
<body>

    <div class="header">
        <span style="font-size: 20px;">üé® Creador Libre</span>
        <div>
            <button class="btn-action btn-add" onclick="agregarPagina()">+ Nueva Hoja</button>
            <button class="btn-action" onclick="finalizarDocumento()">üñ®Ô∏è Terminar PDF</button>
            <a href="/" style="color:white; margin-left:15px; text-decoration:none; font-size:14px;">Salir</a>
        </div>
    </div>

    <div class="workspace">
        <div class="sidebar">
            <div class="upload-btn" onclick="document.getElementById('fileInput').click()">
                üìÇ Cargar Im√°genes
                <input type="file" id="fileInput" multiple style="display:none" onchange="cargarAlBanco(this)">
            </div>
            <div id="imagePool" style="display: flex; flex-direction: column; gap: 10px;"></div>
        </div>

        <div class="canvas-area" id="allPagesContainer">
            </div>
    </div>

    <script>
        let pageCounter = 0;
        let activePageId = null; // Para saber a d√≥nde mandar la foto cuando hacen clic

        // INICIALIZAR
        window.onload = function() {
            agregarPagina(); // Empezar con una hoja
        };

        // 1. GESTI√ìN DE P√ÅGINAS
        function agregarPagina() {
            pageCounter++;
            const container = document.getElementById('allPagesContainer');
            const pageId = 'page-' + pageCounter;

            const wrapper = document.createElement('div');
            wrapper.className = 'page-wrapper';
            wrapper.id = 'wrapper-' + pageCounter;

            wrapper.innerHTML = `
                <div class="page-header">
                    <span>P√°gina ${pageCounter}</span>
                    <button class="btn-del-page" onclick="borrarPagina('${wrapper.id}')">Borrar Hoja</button>
                </div>
                <div class="thePaper" id="${pageId}" onclick="activarPagina('${pageId}')"></div>
            `;

            container.appendChild(wrapper);
            activarPagina(pageId); // La nueva es la activa
            
            // Auto scroll hacia la nueva p√°gina
            wrapper.scrollIntoView({behavior: 'smooth'});
        }

        function borrarPagina(wrapperId) {
            if(document.querySelectorAll('.page-wrapper').length <= 1) {
                return alert("Debes tener al menos una p√°gina.");
            }
            if(confirm("¬øBorrar esta p√°gina y sus fotos?")) {
                document.getElementById(wrapperId).remove();
            }
        }

        function activarPagina(id) {
            activePageId = id;
            // Visualmente quitar 'active' de todas y ponerla a esta
            document.querySelectorAll('.thePaper').forEach(p => p.classList.remove('active-page'));
            document.getElementById(id).classList.add('active-page');
        }

        // 2. CARGAR IM√ÅGENES AL SIDEBAR
        function cargarAlBanco(input) {
            const pool = document.getElementById('imagePool');
            for (const file of input.files) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = 'pool-img';
                img.title = "Clic para agregar a la hoja activa";
                img.onclick = () => agregarAlLienzo(img.src);
                pool.appendChild(img);
            }
            input.value = '';
        }

        // 3. AGREGAR IMAGEN A LA HOJA ACTIVA
        function agregarAlLienzo(src) {
            if(!activePageId) return alert("Selecciona una hoja primero.");
            
            const paper = document.getElementById(activePageId);
            const container = document.createElement('div');
            container.className = 'draggable-item';
            
            // Centrado aproximado
            container.style.top = '100px'; 
            container.style.left = '100px';

            container.innerHTML = `
                <div class="delete-handle" onclick="this.parentElement.remove()">√ó</div>
                <img src="${src}">
            `;
            
            paper.appendChild(container);
        }

        // 4. CONFIGURAR INTERACT.JS (MOVIMIENTO)
        interact('.draggable-item')
        .draggable({
            inertia: true,
            modifiers: [
                interact.modifiers.restrictRect({
                    restriction: 'parent', // Importante: Restringe a SU hoja
                    endOnly: true
                })
            ],
            autoScroll: true,
            listeners: { move: dragMoveListener }
        })
        .resizable({
            edges: { left: true, right: true, bottom: true, top: true },
            modifiers: [
                interact.modifiers.aspectRatio({ ratio: 'preserve' }),
                interact.modifiers.restrictSize({ min: { width: 50, height: 50 } }),
                interact.modifiers.restrictEdges({ outer: 'parent' })
            ],
            listeners: { move: resizeMoveListener }
        });

        function dragMoveListener (event) {
            var target = event.target;
            var x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
            var y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
            target.style.transform = 'translate(' + x + 'px, ' + y + 'px)';
            target.setAttribute('data-x', x);
            target.setAttribute('data-y', y);
        }

        function resizeMoveListener (event) {
            var target = event.target;
            var x = (parseFloat(target.getAttribute('data-x')) || 0);
            var y = (parseFloat(target.getAttribute('data-y')) || 0);
            target.style.width = event.rect.width + 'px';
            target.style.height = event.rect.height + 'px';
            x += event.deltaRect.left;
            y += event.deltaRect.top;
            target.style.transform = 'translate(' + x + 'px, ' + y + 'px)';
            target.setAttribute('data-x', x);
            target.setAttribute('data-y', y);
            target.classList.add('resizing');
        }
        interact('.draggable-item').on('resizeend', function(event){
             event.target.classList.remove('resizing');
        });

        // 5. FINALIZAR: LOOP MULTI-P√ÅGINA
        async function finalizarDocumento() {
            const pages = document.querySelectorAll('.thePaper');
            if(pages.length === 0) return;

            const btn = document.querySelector('button[onclick="finalizarDocumento()"]');
            const originalText = btn.innerText;
            btn.disabled = true;
            
            // Ocultar botones de borrar temporalmente
            document.querySelectorAll('.delete-handle').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.thePaper').forEach(el => el.style.border = 'none'); // Quitar borde azul de selecci√≥n

            let pagesData = [];

            try {
                // Iterar sobre cada hoja y tomar foto
                for (let i = 0; i < pages.length; i++) {
                    btn.innerText = `‚è≥ Procesando p√°gina ${i + 1} de ${pages.length}...`;
                    
                    // html2canvas toma la foto de CADA div .thePaper
                    const canvas = await html2canvas(pages[i], { 
                        scale: 2, 
                        useCORS: true, 
                        backgroundColor: '#ffffff' 
                    });
                    
                    pagesData.push(canvas.toDataURL("image/png"));
                }

                btn.innerText = "‚è≥ Enviando al servidor...";

                // Enviar la LISTA de im√°genes
                const res = await fetch('/api/guardar_canvas_pdf', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ pagesData: pagesData })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    window.location.href = data.pdf_url;
                } else {
                    alert("Error en el servidor: " + data.error);
                }

            } catch (e) {
                console.error(e);
                alert("Error generando el documento.");
            } finally {
                // Restaurar UI
                document.querySelectorAll('.delete-handle').forEach(el => el.style.display = '');
                if(activePageId) document.getElementById(activePageId).classList.add('active-page');
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>