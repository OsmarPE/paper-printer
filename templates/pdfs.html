{% extends 'layout.html' %}

{% block title %}Inicio - Papelería Pro{% endblock %}

{% block content %}
  <style> 
    
        .icon-pdf { 
            width: 3rem; height: 3rem; margin-right: 10px; display: flex; align-items: center; justify-content: center; 
            background: transparent; border-radius: 5px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.4s ease;
        }

        .icon-pdf svg { width: 1.25rem; height: 1.25rem;}
       
        #listaPdfs{
            display: grid;
            /* grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); */
            gap: 1rem;
            margin-top: 2rem;
        }
        .pdf-item{
            padding: .75rem;
            border-radius: 8px;
            background: white;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.05);
            transition: all 0.4s ease;
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        
        }
        .pdf-item-actions{
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            align-items: center;
        }
        .pdf-item-name{
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: .25rem;
        }

        .pdf-item-info, .pdf-item-info-item{
            display: flex;
            align-items: center;
            gap: .5rem;
        }
        .pdf-item-info-item{
            font-size: .875rem;
            color: rgba(0,0,0,0.5);
        }
        .pdf-item-info svg{
            width: 1rem;
            height: 1rem;
        }

    </style>
    <header class="header">
        <div>
           <h2 class="main__title">Documentos PDF</h2>
           <p class="main__text">Documentos disponibles en Descargas</p>
        </div>
        <button class="btn btn--secondary" onclick="cargarPdfs()"> 
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-ccw-icon lucide-refresh-ccw"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
            Actualizar
        </button>
    </header>

   
    <div id="listaPdfs">
        <tr><td colspan="2" style="text-align:center; padding:20px;">Cargando...</td></tr>
    </div>

 
    <div class="modal-overlay" id="printModal">
    <div class="modal">
        <h2 class="modal-title" id="modalPrinterName">Configurar Impresión</h2>
        <p class="modal-text">Selecciona un archivo PDF para imprimir</p>

        <div class="form-group">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <div style="flex:1">
                    <label class="form-label">Copias:</label>
                    <input type="number" id="copies" value="1" min="1">
                </div>
                <div style="flex:1">
                    <label class="form-label">Color:</label>
                    <select id="colorMode" style="width:100%; padding:10px; border-radius:5px; border:1px solid #ddd;">
                        <option value="color">Color</option>
                        <option value="monochrome">Blanco y Negro</option>
                    </select>
                </div>
            </div>
    
            <div>
                <label class="form-label">Tamaño de Papel:</label>
                <select id="paperFormat" style="width:100%; padding:10px; border-radius:5px; border:1px solid #ddd;">
                    <option value="Letter">Carta (Letter)</option>
                    <option value="Legal">Oficio (Legal)</option>
                    <option value="A4">A4 (Europeo)</option>
                </select>
            </div>
    
            <div>
                <label class="form-label">Páginas (Ej: 1-3, 5):</label>
                <input type="text" id="pages" placeholder="Dejar vacío para TODO">
            </div>

        </div>
        <div class="modal-actions">
            <button class="btn btn--secondary" onclick="cerrarModal()">Cancelar</button>
            <button class="btn btn--primary" onclick="enviarImpresion()">Imprimir Ahora</button>
        </div>
    </div>
</div>
    <script>
        let archivoActual = "";
        let impresorasCache = [];

        // 1. Cargar Lista de PDFs (Auto-refresh)
        async function cargarPdfs() {
            try {
                const res = await fetch('/api/listar_pdfs_json');
                const pdfs = await res.json();
                
                const tbody = document.getElementById('listaPdfs');
                
                if(pdfs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; padding:20px;">No hay PDFs recientes</td></tr>';
                    return;
                }

                let html = '';

                function formatDateTime(date) {
                    if (!date) return 'Fecha no válida';

                    // Si viene en segundos, pásalo a milisegundos
                    if (typeof date === 'number' && date < 1e12) {
                        date *= 1000;
                    }

                    const times = new Date(date).toLocaleString('es-ES', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });


                    return { date: times.split(',')[0], time: times.split(',')[1] };

                }

                function getHora12h(time) {
                    let horas = time.split(':')[0];
                    let minutos = time.split(':')[1];

                    const ampm = horas >= 12 ? 'PM' : 'AM';

                    horas = horas % 12;
                    horas = horas ? horas : 12; // si es 0 → 12

                    minutos = minutos.toString().padStart(2, '0');

                    return `${horas}:${minutos} ${ampm}`;
                }

                pdfs.forEach(pdf => {
                    html += `
                        <div class="pdf-item">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span class="icon-pdf">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-icon lucide-file"><path d="M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z"/><path d="M14 2v5a1 1 0 0 0 1 1h5"/></svg>    
                                </span>
                                <div style="display:flex; align-items:center;">
                                    <div>
                                        <div class="pdf-item-name">${pdf.nombre}</div>
                                        <div class="pdf-item-info">  
                                            <div class="pdf-item-info-item">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-icon lucide-calendar"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>
                                                ${formatDateTime(pdf.fecha).date} 
                                            </div>
                                            • 
                                            <div class="pdf-item-info-item">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clock4-icon lucide-clock-4"><path d="M12 6v6l4 2"/><circle cx="12" cy="12" r="10"/></svg>
                                            ${ getHora12h(formatDateTime(pdf.fecha).time) }
                                            </div>
                                            •  
                                            <div class="pdf-item-info-item">
                                            ${pdf.size}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="pdf-item-actions">
                                <button class="btn btn--secondary" id="btn-remove-action" onclick="removePdf('${pdf.nombre}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-icon lucide-trash"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3-3V3a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v1"/><path d="M15.555.555A.5.5.0 .999.778.778l-.778-.778z"/></svg>
                                </button>
                                <a href="/cdn/descargas/${pdf.nombre}" target="_blank" class="btn btn--secondary">Ver</a>
                                <button onclick="abrirImpresion('${pdf.nombre}')" class="btn btn--primary">Imprimir</button>
                            </div>
                        </div>
                    `;
                });
                tbody.innerHTML = html;
            } catch (e) { console.error("Error loading PDFs", e); }
        }

        async function removePdf(nombre) {
            console.log("Borrando PDF:", nombre);
            const confirmacion = confirm(`⚠️ ¿Estás segura de eliminar la imagen ${nombre}?\n\nEsta acción no se puede deshacer.`);
            
            if (!confirmacion) return;
            
            const res = await fetch('/api/borrar_archivos_descargas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ archivos: [nombre] })
            });
            const data = await res.json();

            cargarPdfs();
        }

        // 2. Cargar Impresoras (Una sola vez al inicio)
        async function cargarImpresoras() {
            // Nota: Aquí podrías crear un endpoint simple que devuelva solo nombres de impresoras
            // Por ahora, asumiremos que usamos el endpoint /impresoras pero hay que parsear el HTML
            // MEJOR: Creamos un endpoint JSON rápido en app.py si no existe, o lo simulamos
            // TRUCO RÁPIDO: Copia los nombres de tus impresoras aquí si no quieres hacer otro endpoint
            // O usa el endpoint que ya tenías si lo adaptas a JSON.
            
            // Para que funcione YA, vamos a hacer un fetch al HTML de impresoras y extraer nombres (chapuza funcional)
            // O mejor, agrega este endpoint rápido en app.py:
            /* @app.route('/api/lista_impresoras_simple')
               def lista_simple():
                   return jsonify([p['nombre'] for p in obtener_impresoras()])
            */
            
            // Suponiendo que agregaste ese endpoint arriba o hardcodeamos para probar:
             impresorasCache = ["EPSON L3150 Series", "Microsoft Print to PDF"]; // <--- EJEMPLO, REEMPLAZAR CON FETCH
             
             // Si quieres hacerlo dinámico real, agrega el endpoint JSON en el backend.
        }

        function abrirImpresion(nombre) {
            archivoActual = nombre;
            
            // Llenar select de impresoras
            const select = document.getElementById('printerSelect');
            // Aquí deberías usar 'impresorasCache' real
            // Como no tenemos el endpoint JSON hecho, vamos a pedirle al usuario que escriba el nombre O
            // Si usaste el código anterior de Win32, podemos inyectar las impresoras desde Python al renderizar la plantilla HTML
            // (Ver abajo la corrección en Python)
        }
        
        // CORRECCIÓN PARA IMPRESORAS: 
        // Vamos a inyectar las impresoras desde el servidor al cargar la página.
        // Ver paso 3 abajo.

        function cerrarModal() {
            document.getElementById('printModal').style.display = 'none';
        }

        async function confirmarImpresion() {
            const btn = document.querySelector('.btn-modal');
            btn.disabled = true;
            btn.innerText = "Enviando...";

            const datos = {
                archivo: archivoActual,
                impresora: document.getElementById('printerSelect').value,
                copias: document.getElementById('copies').value,
                color: document.getElementById('colorMode').value,
                rango: document.getElementById('pages').value
            };

            try {
                const res = await fetch('/api/imprimir_local', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(datos)
                });
                const data = await res.json();
                if(data.success) {
                    alert("✅ Enviado correctamente");
                    cerrarModal();
                } else {
                    alert("❌ Error: " + data.msg);
                }
            } catch (e) {
                alert("Error de conexión");
            } finally {
                btn.disabled = false;
                btn.innerText = "✅ Imprimir";
            }
        }

        // Init
        cargarPdfs();
        setInterval(cargarPdfs, 30000); // Refrescar cada 5s

        document.addEventListener("visibilitychange", () => {
            console.log(document.visibilityState);
            if (document.visibilityState === "visible") {
                cargarPdfs();
            }
        });

        // Lógica para abrir modal (pegamento visual)
        window.abrirImpresion = function(nombre) {
            archivoActual = nombre;
            document.getElementById('printModal').style.display = 'flex';
        }
    </script>

{% endblock %}

