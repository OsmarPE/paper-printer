{% extends 'layout.html' %}

{% block title %}Inicio - Papeler√≠a Pro{% endblock %}

{% block content %}
  <style> 
    
        .icon-pdf { 
            width: 3rem; height: 3rem; margin-right: 10px; display: flex; align-items: center; justify-content: center; 
            background: transparent; border-radius: 5px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.4s ease;
        }

        .icon-pdf svg { width: 1.25rem; height: 1.25rem;}
    
        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: white; padding: 30px; border-radius: 15px; width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; }
        select, input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .btn-modal { width: 100%; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        #listaPdfs{
            display: grid;
            /* grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); */
            gap: 1rem;
            margin-top: 2rem;
        }
        .pdf-item{
            padding: .75rem;
            border-radius: 8px;
            background: white;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.05);
            transition: all 0.4s ease;
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        
        }
        .pdf-item-actions{
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            align-items: center;
        }
        .pdf-item-name{
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: .25rem;
        }

        .pdf-item-info, .pdf-item-info-item{
            display: flex;
            align-items: center;
            gap: .5rem;
        }
        .pdf-item-info-item{
            font-size: .875rem;
            color: rgba(0,0,0,0.5);
        }
        .pdf-item-info svg{
            width: 1rem;
            height: 1rem;
        }

    </style>
    <header class="header">
        <div>
           <h2 class="main__title">Documentos PDF</h2>
           <p class="main__text">Documentos disponibles en Descargas</p>
        </div>
        <button class="btn btn--secondary" onclick="cargarPdfs()"> 
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-ccw-icon lucide-refresh-ccw"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
            Actualizar
        </button>
    </header>

   
    <div id="listaPdfs">
        <tr><td colspan="2" style="text-align:center; padding:20px;">Cargando...</td></tr>
    </div>

    <div class="modal-overlay" id="printModal">
        <div class="modal">
            <h2 style="margin-top:0;">üñ®Ô∏è Configurar Impresi√≥n</h2>
            <p id="archivoSeleccionado" style="color:#666; font-size:13px; word-break:break-all;"></p>
            
            <div class="form-group">
                <label>Impresora:</label>
                <select id="printerSelect">
                    <option value="">Cargando impresoras...</option>
                </select>
            </div>

            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1">
                    <label>Copias:</label>
                    <input type="number" id="copies" value="1" min="1">
                </div>
                <div class="form-group" style="flex:1">
                    <label>Color:</label>
                    <select id="colorMode">
                        <option value="monochrome">‚ö´ B/N</option>
                        <option value="color">üé® Color</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>P√°ginas (Ej: 1-5):</label>
                <input type="text" id="pages" placeholder="Todo">
            </div>

            <button class="btn-modal" style="background:#2e7d32; color:white;" onclick="confirmarImpresion()">‚úÖ Imprimir</button>
            <button class="btn-modal" style="background:#ccc; margin-top:5px;" onclick="cerrarModal()">Cancelar</button>
        </div>
    </div>

    <script>
        let archivoActual = "";
        let impresorasCache = [];

        // 1. Cargar Lista de PDFs (Auto-refresh)
        async function cargarPdfs() {
            try {
                const res = await fetch('/api/listar_pdfs_json');
                const pdfs = await res.json();
                
                const tbody = document.getElementById('listaPdfs');
                
                if(pdfs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; padding:20px;">No hay PDFs recientes</td></tr>';
                    return;
                }

                let html = '';

                function formatDateTime(date) {
                    if (!date) return 'Fecha no v√°lida';

                    // Si viene en segundos, p√°salo a milisegundos
                    if (typeof date === 'number' && date < 1e12) {
                        date *= 1000;
                    }

                    const times = new Date(date).toLocaleString('es-ES', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });


                    return { date: times.split(',')[0], time: times.split(',')[1] };

                }

                function getHora12h(time) {
                    let horas = time.split(':')[0];
                    let minutos = time.split(':')[1];

                    const ampm = horas >= 12 ? 'PM' : 'AM';

                    horas = horas % 12;
                    horas = horas ? horas : 12; // si es 0 ‚Üí 12

                    minutos = minutos.toString().padStart(2, '0');

                    return `${horas}:${minutos} ${ampm}`;
                }

                pdfs.forEach(pdf => {
                    html += `
                        <div class="pdf-item">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span class="icon-pdf">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-icon lucide-file"><path d="M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z"/><path d="M14 2v5a1 1 0 0 0 1 1h5"/></svg>    
                                </span>
                                <div style="display:flex; align-items:center;">
                                    <div>
                                        <div class="pdf-item-name">${pdf.nombre}</div>
                                        <div class="pdf-item-info">  
                                            <div class="pdf-item-info-item">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-icon lucide-calendar"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>
                                                ${formatDateTime(pdf.fecha).date} 
                                            </div>
                                            ‚Ä¢ 
                                            <div class="pdf-item-info-item">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clock4-icon lucide-clock-4"><path d="M12 6v6l4 2"/><circle cx="12" cy="12" r="10"/></svg>
                                            ${ getHora12h(formatDateTime(pdf.fecha).time) }
                                            </div>
                                            ‚Ä¢  
                                            <div class="pdf-item-info-item">
                                            ${pdf.size}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="pdf-item-actions">
                                <button class="btn btn--secondary" id="btn-remove-action" onclick="removePdf('${pdf.nombre}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-icon lucide-trash"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3-3V3a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v1"/><path d="M15.555.555A.5.5.0 .999.778.778l-.778-.778z"/></svg>
                                </button>
                                <a href="/cdn/descargas/${pdf.nombre}" target="_blank" class="btn btn--secondary">Ver</a>
                                <button onclick="abrirImpresion('${pdf.nombre}')" class="btn btn--primary">Imprimir</button>
                            </div>
                        </div>
                    `;
                });
                tbody.innerHTML = html;
            } catch (e) { console.error("Error loading PDFs", e); }
        }

        async function removePdf(nombre) {
            console.log("Borrando PDF:", nombre);
            const confirmacion = confirm(`‚ö†Ô∏è ¬øEst√°s segura de eliminar la imagen ${nombre}?\n\nEsta acci√≥n no se puede deshacer.`);
            
            if (!confirmacion) return;
            
            const res = await fetch('/api/borrar_archivos_descargas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ archivos: [nombre] })
            });
            const data = await res.json();

            cargarPdfs();
        }

        // 2. Cargar Impresoras (Una sola vez al inicio)
        async function cargarImpresoras() {
            // Nota: Aqu√≠ podr√≠as crear un endpoint simple que devuelva solo nombres de impresoras
            // Por ahora, asumiremos que usamos el endpoint /impresoras pero hay que parsear el HTML
            // MEJOR: Creamos un endpoint JSON r√°pido en app.py si no existe, o lo simulamos
            // TRUCO R√ÅPIDO: Copia los nombres de tus impresoras aqu√≠ si no quieres hacer otro endpoint
            // O usa el endpoint que ya ten√≠as si lo adaptas a JSON.
            
            // Para que funcione YA, vamos a hacer un fetch al HTML de impresoras y extraer nombres (chapuza funcional)
            // O mejor, agrega este endpoint r√°pido en app.py:
            /* @app.route('/api/lista_impresoras_simple')
               def lista_simple():
                   return jsonify([p['nombre'] for p in obtener_impresoras()])
            */
            
            // Suponiendo que agregaste ese endpoint arriba o hardcodeamos para probar:
             impresorasCache = ["EPSON L3150 Series", "Microsoft Print to PDF"]; // <--- EJEMPLO, REEMPLAZAR CON FETCH
             
             // Si quieres hacerlo din√°mico real, agrega el endpoint JSON en el backend.
        }

        function abrirImpresion(nombre) {
            archivoActual = nombre;
            document.getElementById('archivoSeleccionado').innerText = nombre;
            
            // Llenar select de impresoras
            const select = document.getElementById('printerSelect');
            // Aqu√≠ deber√≠as usar 'impresorasCache' real
            // Como no tenemos el endpoint JSON hecho, vamos a pedirle al usuario que escriba el nombre O
            // Si usaste el c√≥digo anterior de Win32, podemos inyectar las impresoras desde Python al renderizar la plantilla HTML
            // (Ver abajo la correcci√≥n en Python)
        }
        
        // CORRECCI√ìN PARA IMPRESORAS: 
        // Vamos a inyectar las impresoras desde el servidor al cargar la p√°gina.
        // Ver paso 3 abajo.

        function cerrarModal() {
            document.getElementById('printModal').style.display = 'none';
        }

        async function confirmarImpresion() {
            const btn = document.querySelector('.btn-modal');
            btn.disabled = true;
            btn.innerText = "Enviando...";

            const datos = {
                archivo: archivoActual,
                impresora: document.getElementById('printerSelect').value,
                copias: document.getElementById('copies').value,
                color: document.getElementById('colorMode').value,
                rango: document.getElementById('pages').value
            };

            try {
                const res = await fetch('/api/imprimir_local', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(datos)
                });
                const data = await res.json();
                if(data.success) {
                    alert("‚úÖ Enviado correctamente");
                    cerrarModal();
                } else {
                    alert("‚ùå Error: " + data.msg);
                }
            } catch (e) {
                alert("Error de conexi√≥n");
            } finally {
                btn.disabled = false;
                btn.innerText = "‚úÖ Imprimir";
            }
        }

        // Init
        cargarPdfs();
        setInterval(cargarPdfs, 30000); // Refrescar cada 5s

        document.addEventListener("visibilitychange", () => {
            console.log(document.visibilityState);
            if (document.visibilityState === "visible") {
                cargarPdfs();
            }
        });

        // L√≥gica para abrir modal (pegamento visual)
        window.abrirImpresion = function(nombre) {
            archivoActual = nombre;
            document.getElementById('archivoSeleccionado').innerText = nombre;
            document.getElementById('printModal').style.display = 'flex';
        }
    </script>

{% endblock %}

